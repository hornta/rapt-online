var i=true,m=null,q=false;function x(){return function(){}}function P(F){return function(G){this[F]=G}}function Q(F){return function(){return this[F]}}
(function(){function F(a,b,c,d){this.b=a;this.x=b;this.y=c;this.type=d;this.$b=a.ja(b,c)}function G(a,b){this.b=a;this.Yb=a.getSelection();this.selection=b}function Aa(a,b){this.b=a;this.ka=b}function oa(a,b){this.b=a;this.ka=b}function T(a,b){this.b=a;this.ra=b;this.Ma=[];this.selection=a.getSelection();for(var c=0;c<this.selection.length;c++)this.Ma.push(this.selection[c].sa())}function U(a,b){this.b=a;this.u=b;this.Xb=a.u}function V(a,b){this.b=a;this.B=b;this.Wb=a.B}function Ba(a){this.m=a;this.F=
a.F}function W(a,b){this.b=a;this.Ea=b;this.Na=[];this.selection=a.getSelection();for(var c=0;c<this.selection.length;c++)this.Na.push(this.selection[c].ta())}function Ca(a,b){this.hb=a;this.text=b;this.Zb=a.text}function y(){this.b=new z;this.g=new B}function t(a,b){this.start=a;this.end=b}function Ua(){}function u(a){this.canvas=a;this.Ba=a.getContext("2d");this.J=new h(0,0);this.Q=50;this.w=m;this.a=new y;this.fb(Da);this.M=this.xa=0;this.Ka=q;this.height=this.width=0;this.a.b.u=new h(-2,-1);this.a.b.B=
new h(1,-1);this.a.b.s(-2,-1,E);this.a.b.s(-2,0,E);this.a.b.s(-1,0,E);this.a.b.s(0,0,E);this.a.b.s(1,0,E);this.a.b.s(1,-1,E);this.K=[];for(a=pa;a<=qa;a++)this.K.push({name:C[a].name,f:C[a].f});for(a=Ea;a<=Fa;a++){this.K.push({name:C[a].name,f:C[a].f.clone(new h(0,0),Va)});this.K.push({name:C[a].name,f:C[a].f.clone(new h(0,0),Wa)})}}function Ga(a){clearTimeout(Xa);Xa=setTimeout(function(){$("#overlay").fadeOut()},600);$("#overlay").html(a).show().stop().fadeTo(0,1)}function mb(a){function b(){$("#loading").html("Could not load level from<br><b>"+
getLevelURL()+"</b>")}$.ajax({url:"//"+location.host+"/data/"+username+"/"+levelname+"/",type:"GET",cache:q,dataType:"json",success:function(c){c!=m?a(JSON.parse(c.data)):b()},error:function(){b()}})}function Ya(a,b){Ga("Saving");$.ajax({url:"//"+location.host+"/edit/"+levelname+"/",type:"PUT",beforeSend:function(c){c.setRequestHeader("X-CSRF-Token",$('meta[name="csrf-token"]').attr("content"))},dataType:"json",data:JSON.stringify({level:{data:a}}),contentType:"application/json; charset=utf-8",success:function(){Ga("Saved");
b&&b()},error:function(){alert("Could not save level to\n"+getLevelURL())}})}function Ha(){var a=$("#toolbar").outerHeight(),b=0;if(n.i==Ia){$("#help").css({top:a+"px"});b=$("#help").outerWidth()}if(n.i==X){$("#enemies").css({top:a+"px"});b=$("#enemies").outerWidth()}if(n.i==Y){$("#walls").css({top:a+"px"});b=$("#walls").outerWidth()}n.resize($(window).width()-b,$(window).height()-a);n.c()}function nb(a){a==Ia?$("#help").show():$("#help").hide();a==X?$("#enemies").show():$("#enemies").hide();a==Y?
$("#walls").show():$("#walls").hide();Ha()}function Z(a){var b=$("#canvas").offset();return new h(a.pageX-b.left,a.pageY-b.top)}function ob(){var a=navigator.platform.indexOf("Mac")!=-1,b=a?"^":"Ctrl+",c=a?"&#x21E7;":"Shift+",d=a?"&#x2318;":"Win+";a=["Save",(a?d:b)+"S","Undo",(a?d:b)+"Z","Redo",a?c+d+"Z":b+"Y","Select all",(a?d:b)+"A","Delete selection",a?"&#x232B;":"Backspace","---","---","Pan camera",/safari/i.test(navigator.userAgent)&&!/chrome/i.test(navigator.userAgent)?"Middle-drag":"Right-drag",
"Zoom camera","Scrollwheel","Move selection","Left-drag","---","---","Edit sign","Double-click"];b=new J;for(c=0;c<a.length;c++)b.ca(a[c]);$("#help").html(b.Ha()+'<hr>To change starting direction for Bombers, Jet Streams, Wall Crawlers, and Wheeligators, select them and drag the triangle (must be in "Select" mode).')}function pb(){var a=new J,b;a.da("Color-neutral enemies");for(b=0;b<n.K.length;b++){b==10&&a.da("Color-specific enemies");a.ca('<div class="cell" id="enemy'+b+'"><canvas id="enemy'+b+
'-canvas" width="80" height="60"></canvas>'+n.K[b].name+"</div>")}$("#enemies").html(a.Ha());$("#enemy"+n.xa).addClass("enemy-current");for(b=0;b<n.K.length;b++){a=$("#enemy"+b+"-canvas")[0].getContext("2d");a.translate(40,30);a.scale(50,-50);a.lineWidth=0.02;a.fillStyle=a.strokeStyle="green";var c=n.K[b].f;if(b==Ja)c=c.clone(new h(0,-0.2));c.c(a)}$("#enemies .cell").mousedown(function(d){n.ec(parseInt(/\d+$/.exec(this.id),10));$(".enemy-current").removeClass("enemy-current");$(this).addClass("enemy-current");
d.preventDefault()})}function qb(){var a=new J,b;a.da("Walls");a.Aa("Colored walls allow only the player of that color to pass through");for(b=0;b<6;b++)a.ca('<div class="cell" id="wall'+b+'"><canvas id="wall'+b+'-canvas" width="80" height="60"></canvas>'+(b&1?"One-way":"Normal")+"</div>");a.da("Buttons");a.Aa("Buttons open and close linked doors");var c=["Open","Close","Toggle","Link","Set Initially Open"];for(b=6;b<9;b++)a.ca('<div class="cell" id="button'+b+'"><canvas id="button'+b+'-canvas" width="80" height="60"></canvas>'+
c.shift()+"</div>");a.da("Doors");a.Aa("Create doors by linking walls and buttons");for(b=9;b<11;b++)a.ca('<div class="cell" id="door'+b+'"><canvas id="door'+b+'-canvas" width="80" height="60"></canvas>'+c.shift()+"</div>");$("#walls").html(a.Ha());$("#wall"+n.xa).addClass("wall-current");for(b=0;b<6;b++){a=$("#wall"+b+"-canvas")[0].getContext("2d");a.translate(40,30);a.scale(50,-50);a.lineWidth=0.02;(new s(b&1,q,Math.floor(b/2),new t(new h(0.4,0.4),new h(-0.4,-0.4)))).c(a)}for(b=6;b<9;b++){a=$("#button"+
b+"-canvas")[0].getContext("2d");a.translate(40,30);a.scale(50,-50);a.lineWidth=0.02;l.Fa(a,1)}for(b=9;b<11;b++){a=$("#door"+b+"-canvas")[0].getContext("2d");a.translate(40,30);a.scale(50,-50);a.lineWidth=0.02;if(b==9){a.strokeStyle=k(0,0,0,0.5);Ka(a,new h(-0.3,0.2),new h(0.3,0));a.translate(-0.3,0.2);l.Fa(a,1);a.translate(0.3,-0.2);(new s(i,q,La,new t(new h(0.7,0.4),new h(-0.1,-0.4)))).c(a)}else(new s(i,i,La,new t(new h(0.4,0.4),new h(-0.4,-0.4)))).c(a)}$("#walls .cell").mousedown(function(d){n.fc(parseInt(/\d+$/.exec(this.id),
10));$(".wall-current").removeClass("wall-current");$(this).addClass("wall-current");d.preventDefault()})}function Za(a,b){Ma=b;$("#sign-text-modal button").removeClass("sign-text-active");$("#sign-text-modal").show().animate({top:0});$("#darken").fadeIn();$("#sign-text").val(a).focus().select()}function $a(){$("#sign-text-modal").animate({top:-115},function(){$("#sign-text-modal").hide()});$("#darken").fadeOut();return $("#sign-text").blur().val()}function ab(){$("#sign-text-change").addClass("sign-text-active");
var a=$a();Ma&&Ma(a)}function bb(){$("#sign-text-cancel").addClass("sign-text-active");$a()}function cb(){$("#toolbar .section a").mousedown(function(e){var g=rb[this.id];n.fb(g);$(".toolbar-current").removeClass("toolbar-current");$(this).addClass("toolbar-current");e.preventDefault();nb(g);if(g==db){var j=n.a.g.C;Ya(n.save(),function(){n.a.g.eb(j);history.back();window.close()})}});$("#sign-text-modal button").mousedown(function(e){e.preventDefault()});$("#sign-text-change").mouseup(function(e){ab();
e.preventDefault()});$("#sign-text-cancel").mouseup(function(e){bb();e.preventDefault()});$("#sign-text").focus(function(){Na=i});$("#sign-text").blur(function(){Na=q});$("#sign-text").keydown(function(e){if(e.which==sb)ab();else e.which==tb&&bb()});var a=$("#canvas")[0];n=new u(a);Ha();pb();qb();ob();var b=q,c=q,d=q,f=q;$(a).mousedown(function(e){R|=1<<e.which;n.t(Z(e),R,b|c|d|f);e.preventDefault()});$(a).mousemove(function(e){n.h(Z(e),R);e.preventDefault()});$(a).mouseup(function(e){R&=~(1<<e.which);
n.A(Z(e),R);e.preventDefault()});$(a).mousewheel(function(e,g,j,p){n.Sb(j,p);n.h(Z(e));e.preventDefault()});$(a).mouseenter(function(){n.Rb()});$(a).mouseleave(function(){n.Qb()});$(a).dblclick(function(e){R=0;e.preventDefault();n.ob(Z(e))});$(window).resize(function(){Ha()});$(document).bind("contextmenu",function(e){e.preventDefault()});$(document).keydown(function(e){if(e.which==eb)b=i;else if(e.which==fb)c=i;else if(e.which==gb)d=i;else if(e.which==hb)f=i;else if(!Na)if(e.ctrlKey||e.metaKey)if(e.which==
"Z".charCodeAt(0)){e.shiftKey?n.j():n.l();e.preventDefault()}else if(e.which=="Y".charCodeAt(0)){n.j();e.preventDefault()}else if(e.which=="S".charCodeAt(0)){e.preventDefault();var g=n.a.g.C;Ya(n.save(),function(){n.a.g.eb(g)})}else{if(e.which=="A".charCodeAt(0)){n.bc();e.preventDefault()}}else if(e.which==8){n.nb();e.preventDefault()}});$(document).keyup(function(e){if(e.which==eb)b=q;else if(e.which==fb)c=q;else if(e.which==gb)d=q;else if(e.which==hb)f=q});$(window).blur(function(){b=c=d=f=q});
$(window).focusout(function(){b=c=d=f=q});$(window).bind("beforeunload",function(){if(!n.a.Mb())return"Some of your edits are not saved, and will be lost if you close this window.  Continue?"})}function J(){this.Ia=q;this.va=0;this.html=""}function l(){}function A(a,b,c,d,f,e){d*=Math.PI/180;f=d+f*Math.PI/180;var g=b+Math.sin(d)*e;d=c-Math.cos(d)*e;a.beginPath();a.moveTo(b,c);a.lineTo(g,d);a.lineTo(g+Math.sin(f)*e,d-Math.cos(f)*e);a.stroke()}function Oa(a){for(var b=[],c=0;c<a;c++)b.push(0.2*(0.5+
1*Math.random()));return function(d){d.beginPath();for(var f=0;f<a;f++){var e=f*(2*Math.PI/a),g=b[f];d.moveTo(0,0);d.lineTo(Math.cos(e)*g,Math.sin(e)*g)}d.stroke()}}function aa(a){this.J=a;this.Oa=new h(0,0)}function N(a,b){this.a=a;this.i=b;this.z=q;this.fa=this.R=this.X=m}function ba(a,b,c,d){this.a=a;this.$=b;this.F=c;this.color=d;this.e=m}function ca(a){this.a=a;this.i=ib;this.start=this.end=m;this.La=q;this.U=[];this.Qa=m}function da(a){this.a=a;this.v=m;this.z=q}function ea(a){this.a=a;this.v=
m;this.z=q}function K(a,b){this.a=a;this.la=b;this.v=m}function fa(a){this.a=a;this.I=this.n=m;this.ua=this.Ja=q}function ga(a){this.a=a;this.m=m}function ra(){this.type=S;this.ic=[q,q,q,q,q]}function ha(a,b){this.offset=new h(a,b);this.cells=Array(r*r);for(var c=0;c<r*r;c++)this.cells[c]=new ra}function z(){this.offset=new h(0,0);this.size=new h(0,0);this.G=[];this.d=[];this.u=new h(0,0);this.B=new h(0,0)}function v(a,b){this.anchor=a;this.type=b}function s(a,b,c,d){this.$=a;this.F=b;this.e=d;this.color=
c;this.selected=q;this.na();this.Vb=d.start.sub(this.anchor);this.Ub=d.end.sub(this.anchor)}function w(a,b){this.button=a;this.m=b}function o(a,b,c,d,f,e){this.id=a;this.r=b;this.Za=c;this.anchor=d||new h(0,0);this.color=f||0;this.W=e||0;this.text="";this.O=m}function L(a){return new h(a[0],a[1])}function M(a){return[a.x,a.y]}function ub(a,b){for(var c=[],d=0;d<b.d.length;d++){var f=b.d[d];f instanceof w&&f.button===a&&c.push(f)}var e=[];for(d=0;d<c.length;d++){f=c[d];for(var g=0,j=0;j<b.d.length;j++){var p=
b.d[j];if(p instanceof s){if(p===f.m){e.push(g);break}g++}}}return e.sort()}function k(a,b,c,d){return"rgba("+a+", "+b+", "+c+", "+d.toFixed(5)+")"}function Ka(a,b,c){c=c.sub(b);var d=c.length()*10;c=c.ha(d);a.beginPath();for(var f=0;f+1<d;f+=2){a.moveTo(b.x,b.y);b=b.add(c);a.lineTo(b.x,b.y);b=b.add(c)}if(f<d){a.moveTo(b.x,b.y);b=b.add(c.q(d-f));a.lineTo(b.x,b.y)}a.stroke()}function jb(a,b){var c=b.split(" "),d=[],f="";a.font="12px sans serif";for(var e=vb*50,g=0,j=0;j<c.length;++j){var p=c[j];g=
a.measureText(f+p).width;if(g<e)f+=" "+p;else{f.length>0&&d.push(f);f=p}if(j==c.length-1){d.push(f);break}}return d}function D(a,b){this.min=new h(Math.min(a.x,b.x),Math.min(a.y,b.y));this.max=new h(Math.max(a.x,b.x),Math.max(a.y,b.y))}function ia(a,b){this.Ca=a;this.r=b}function Pa(){this.ba=Array.prototype.slice.call(arguments)}function ja(){this.k=[]}function B(){this.H=[];this.k=[];this.qa=this.C=0}function h(a,b){this.x=a;this.y=b}F.prototype.l=function(){this.b.s(this.x,this.y,this.$b)};F.prototype.j=
function(){this.b.s(this.x,this.y,this.type)};F.prototype.aa=function(a){if(a instanceof F&&this.x==a.x&&this.y==a.y&&this.type==a.type)return i;return q};G.prototype.l=function(){this.b.N(this.Yb)};G.prototype.j=function(){this.b.N(this.selection)};G.prototype.aa=function(a){if(a instanceof G){this.selection=a.selection;return i}return q};Aa.prototype.l=function(){this.b.wa(this.ka)};Aa.prototype.j=function(){this.b.V(this.ka)};oa.prototype.l=function(){this.b.V(this.ka)};oa.prototype.j=function(){this.b.wa(this.ka)};
T.prototype.l=function(){for(var a=0;a<this.selection.length;a++)this.selection[a].oa(this.Ma[a])};T.prototype.j=function(){for(var a=0;a<this.selection.length;a++)this.selection[a].oa(this.Ma[a].add(this.ra))};T.prototype.aa=function(a){if(a instanceof T){this.ra=this.ra.add(a.ra);return i}return q};U.prototype.l=function(){this.b.u=this.Xb};U.prototype.j=function(){this.b.u=this.u};U.prototype.aa=function(a){if(a instanceof U){this.u=a.u;return i}return q};V.prototype.l=function(){this.b.B=this.Wb};
V.prototype.j=function(){this.b.B=this.B};V.prototype.aa=function(a){if(a instanceof V){this.B=a.B;return i}return q};Ba.prototype.l=function(){this.m.F=this.F};Ba.prototype.j=function(){this.m.F=!this.F};W.prototype.l=function(){for(var a=0;a<this.selection.length;a++)this.selection[a].pa(this.Na[a])};W.prototype.j=function(){for(var a=0;a<this.selection.length;a++)this.selection[a].pa(this.Na[a]+this.Ea)};W.prototype.aa=function(a){if(a instanceof W){this.Ea+=a.Ea;return i}return q};Ca.prototype.l=
function(){this.hb.text=this.Zb};Ca.prototype.j=function(){this.hb.text=this.text};y.prototype.s=function(a,b,c){this.g.push(new F(this.b,a,b,c))};y.prototype.V=function(a){this.g.push(new Aa(this.b,a))};y.prototype.wa=function(a){this.g.push(new oa(this.b,a));if(a instanceof v||a instanceof s){var b=[],c;for(c=0;c<this.b.d.length;c++){var d=this.b.d[c];if(d instanceof w&&(d.button==a||d.m==a))b.push(d)}for(c=0;c<b.length;c++)this.g.push(new oa(this.b,b[c]))}};y.prototype.N=function(a){var b=this.b.getSelection(),
c=b.length==a.length;if(c)for(var d=0;d<b.length;d++){for(var f=q,e=0;e<a.length;e++)if(b[d]==a[e]){f=i;break}if(f==q){c=q;break}}c||this.g.push(new G(this.b,a))};y.prototype.Tb=function(a){this.g.push(new T(this.b,a))};y.prototype.ac=function(a){this.g.push(new W(this.b,a))};y.prototype.dc=function(a){this.g.push(new U(this.b,a))};y.prototype.cc=function(a){this.g.push(new V(this.b,a))};y.prototype.hc=function(a){this.g.push(new Ba(a))};y.prototype.gb=function(a,b){this.g.push(new Ca(a,b))};y.prototype.Mb=
function(){for(var a=this.g.C,b=this.g.qa;a>b;){var c=this.g.k[a-1];if(c instanceof G||c instanceof ja&&c.k.length==1&&c.k[0]instanceof G)a--;else break}return a==b};t.prototype.gc=function(a){var b=this.end.sub(this.start),c=a.sub(this.start).ia(b)/b.L();c=Math.max(0.01,Math.min(0.99,c));return this.start.add(b.q(c)).sub(a).L()};t.prototype.ma=function(a){return a.sub(this.start).ia(this.end.sub(this.start).D())<0};t.prototype.D=function(){var a=this.start;this.start=this.end;this.end=a};t.prototype.Pa=
function(a){return this.start.q(1-a).add(this.end.q(a))};t.prototype.Ya=function(a,b){for(var c=this.end.sub(this.start).D().Ta(),d=1;d<9;d++){var f=this.Pa(d/9),e=b?0.05:0;a.moveTo(f.x+c.x*e,f.y+c.y*e);a.lineTo(f.x+c.x*0.1,f.y+c.y*0.1)}};t.prototype.c=function(a){a.beginPath();a.moveTo(this.start.x,this.start.y);a.lineTo(this.end.x,this.end.y);this.Ya(a,q);a.stroke()};t.prototype.ab=function(a){this.Pa(1/9);this.Pa(8/9);a.beginPath();a.moveTo(this.start.x,this.start.y);a.lineTo(this.end.x,this.end.y);
this.Ya(a,i);a.stroke()};Ua.Lb=function(a,b){for(var c=m,d=Number.MAX_VALUE,f=0;f<b.length;f++){var e=b[f].gc(a);if(e<d){d=e;c=b[f]}}return c};var Da=0,X=8,Y=9,Ia=10,db=11;u.prototype.Nb=function(a){var b=this.a,c=new z;c.u=L(a.start);c.B=L(a.end);c.size=new h(Math.ceil(a.width/r),Math.ceil(a.height/r));for(var d=0;d<a.width;d++)for(var f=0;f<a.height;f++)c.s(d,f,a.cells[f][d]);d=[];f=[];for(var e=0;e<a.entities.length;e++){var g=a.entities[e];switch(g["class"]){case "cog":c.d.push(C[sa].f.clone(L(g.pos)));
break;case "wall":g=new s(g.oneway,g.open,g.color,new t(L(g.start),L(g.end)));d.push(g);c.d.push(g);break;case "button":var j=new v(L(g.pos),g.type);j.Ua=g.walls;f.push(j);c.d.push(j);break;case "sign":j=C[O].f.clone(L(g.pos),La,0);j.text=g.text;c.d.push(j);break;case "enemy":c.d.push(C[Qa[g.type]].f.clone(L(g.pos),g.color,g.angle))}}for(e=0;e<f.length;e++){j=f[e];for(a=0;a<j.Ua.length;a++)c.d.push(new w(j,d[j.Ua[a]]));delete j.Ua}b.b=c;this.J=this.a.b.u.add(new h(0.5,0.5));this.c()};u.prototype.fb=
function(a){this.i=a;switch(a){case Da:this.o=new N(this.a,kb);break;case 1:this.o=new N(this.a,wb);break;case 2:this.o=new N(this.a,lb);break;case 7:this.o=new ca(this.a);break;case 3:this.o=new da(this.a);break;case 4:this.o=new ea(this.a);break;case 5:this.o=new K(this.a,C[sa].f);break;case 6:this.o=new K(this.a,C[O].f);break;case X:case Y:this.Sa();break;default:this.o=m}};u.prototype.Sa=function(){if(this.i==X)this.o=new K(this.a,this.K[this.xa].f);else if(this.i==Y)this.o=this.M<6?new ba(this.a,
this.M&1,q,Math.floor(this.M/2)):this.M<9?new K(this.a,new v(m,this.M-6)):this.M==9?new fa(this.a):this.M==10?new ga(this.a):m};u.prototype.resize=function(a,b){var c=window.devicePixelRatio;this.width=a;this.height=b;this.canvas.width=Math.round(a*c);this.canvas.height=Math.round(b*c);this.canvas.style.width=a+"px";this.canvas.style.height=b+"px";this.Ba.scale(c,c)};u.prototype.c=function(){var a=this.Ba,b=this.width,c=this.height;a.fillStyle="#7F7F7F";a.fillRect(0,0,b,c);a.save();a.translate(Math.round(b/
2)+0.5,Math.round(c/2)+0.5);a.scale(this.Q,-this.Q);a.translate(-this.J.x,-this.J.y);a.lineWidth=1/this.Q;this.a.b.c(a);this.vb();this.Ka&&this.o!=m&&this.o.c(a);a.restore()};u.prototype.vb=function(){var a=this.Ba,b=Math.log(50/this.Q)/Math.log(2),c=b<1?1:1<<Math.floor(b),d=2*c;b=b<0?1:1-b+Math.floor(b);var f=this.P(new h(0,this.height)),e=this.P(new h(this.width,0)),g=Math.floor(f.x/d)*d;f=Math.floor(f.y/d)*d;var j=Math.ceil(e.x/d)*d;d=Math.ceil(e.y/d)*d;a.strokeStyle=k(0,0,0,0.2);a.beginPath();
for(e=g;e<=j;e+=2*c){a.moveTo(e,f);a.lineTo(e,d)}for(e=f;e<=d;e+=2*c){a.moveTo(g,e);a.lineTo(j,e)}a.stroke();a.strokeStyle=k(0,0,0,0.2*b*b);a.beginPath();for(e=g+c;e<=j;e+=2*c){a.moveTo(e,f);a.lineTo(e,d)}for(e=f+c;e<=d;e+=2*c){a.moveTo(g,e);a.lineTo(j,e)}a.stroke()};u.prototype.t=function(a,b,c){if(b==4||b==8){this.w=new aa(this.J);this.w.t(this.P(a))}else if(b==2){this.w=this.o;if(this.w!=m){this.a.g.Jb();this.w.La=c;this.w.t(this.P(a))}}this.c()};u.prototype.h=function(a){this.w!=m&&this.w.h(this.P(a));
this.o!=m&&this.o.h(this.P(a));this.c()};u.prototype.A=function(a){this.w!=m&&this.w.A(this.P(a));this.w=m;this.c()};u.prototype.Sb=function(a,b){this.Q=Math.max(1,this.Q*Math.pow(1.1,b));this.c()};u.prototype.Rb=function(){this.Ka=i;this.c()};u.prototype.Qb=function(){this.Ka=q;this.c()};u.prototype.ob=function(a){a=this.P(a);var b=this.a.b.Ra(new D(a,a));if(b.length>1)Ga("Multiple selection");else if(b.length==1&&b[0]instanceof o&&b[0].id==O){this.a.N(b);this.c();Za(b[0].text,function(c){n.a.gb(b[0],
c);n.c()})}};u.prototype.P=function(a){return new h((a.x-this.width/2)/this.Q+this.J.x,(this.height/2-a.y)/this.Q+this.J.y)};u.prototype.l=function(){this.a.g.l();this.c()};u.prototype.j=function(){this.a.g.j();this.c()};u.prototype.save=function(){for(var a=this.a.b,b={},c=new h(Number.MAX_VALUE,Number.MAX_VALUE),d=new h(-Number.MAX_VALUE,-Number.MAX_VALUE),f=0;f<a.G.length;f++)for(var e=a.G[f],g=0;g<r;g++)for(var j=e.offset.y*r+g,p=0;p<r;p++){var H=e.offset.x*r+p;if(e.cells[p+g*r].type!=S){c=c.Pb(new h(H,
j));d=d.Ob(new h(H+1,j+1))}}if(c.x==Number.MAX_VALUE)c.x=c.y=d.x=d.y=0;b.cells=[];b.width=d.x-c.x;b.height=d.y-c.y;for(g=c.y;g<d.y;g++){f=[];for(p=c.x;p<d.x;p++)f.push(a.ja(p,g));b.cells.push(f)}b.entities=[];for(f=0;f<a.d.length;f++){d=a.d[f];if(d instanceof v)b.entities.push({"class":"button",type:d.type,pos:M(d.anchor.sub(c)),walls:ub(d,a)});else if(d instanceof s)b.entities.push({"class":"wall",oneway:!!d.$,open:!!d.F,start:M(d.e.start.sub(c)),end:M(d.e.end.sub(c)),color:d.color});else if(d instanceof
o&&d.id==sa)b.entities.push({"class":"cog",pos:M(d.anchor.sub(c))});else if(d instanceof o&&d.id==O)b.entities.push({"class":"sign",pos:M(d.anchor.sub(c)),text:d.text});else if(d instanceof o){var I;a:{g=void 0;for(g in Qa)if(Qa[g]==d.id){I=g;break a}}b.entities.push({"class":"enemy",type:I,pos:M(d.anchor.sub(c)),color:d.color,angle:d.W-Math.floor(d.W/(2*Math.PI))*2*Math.PI})}}b.unique_id=Math.round(Math.random()*4294967295);b.start=M(a.u.sub(c));b.end=M(a.B.sub(c));return JSON.stringify(b)};u.prototype.nb=
function(){var a=this.a.b.getSelection();this.a.g.ea();for(var b=0;b<a.length;b++)this.a.wa(a[b]);this.a.g.Y();this.c()};u.prototype.bc=function(){for(var a=[],b=this.a.b.d,c=0;c<b.length;c++)a.push(b[c]);this.a.N(a);this.c()};u.prototype.ec=function(a){this.xa=a;this.Sa()};u.prototype.fc=function(a){this.M=a;this.Sa()};var sb=13,tb=27,eb=17,fb=16,gb=91,hb=18,Xa=m,rb={mode_empty:Da,mode_solid:1,mode_diagonal:2,mode_start:3,mode_goal:4,mode_cog:5,mode_sign:6,mode_select:7,mode_enemies:X,mode_walls_buttons:Y,
mode_help:Ia,mode_save_exit:db},n=m,R=0,Na=q,Ma=m;$(document).ready(function(){typeof username==="undefined"?cb():mb(function(a){cb();n.Nb(a)})});J.prototype.ca=function(a){this.ya(i);this.va&1||(this.html+="<tr>");this.html+="<td>"+a.replace(/^---$/,"<hr>")+"</td>";if(this.va&1)this.html+="</tr>";this.va++};J.prototype.da=function(a){this.ya(q);this.html+='<div class="header">'+a+"</div>"};J.prototype.Aa=function(a){this.ya(q);this.html+='<div class="info">'+a+"</div>"};J.prototype.ya=function(a){if(!this.Ia&&
a)this.html+="<table>";else if(this.Ia&&!a){this.html+="</table>";this.va=0}this.Ia=a};J.prototype.Ha=function(){this.ya(q);return this.html};l.bb=function(a,b,c){a.strokeStyle=a.fillStyle=k(255,255,255,b*0.1);a.beginPath();a.arc(c.x,c.y,1,0,2*Math.PI,q);a.stroke();a.fill();var d=a.createLinearGradient(0,c.y-0.4,0,c.y+0.6);d.addColorStop(0,k(255,255,255,b*0.75));d.addColorStop(1,k(255,255,255,0));a.fillStyle=d;a.beginPath();a.lineTo(c.x-0.35,c.y+0.6);a.lineTo(c.x-0.1,c.y-0.4);a.lineTo(c.x+0.1,c.y-
0.4);a.lineTo(c.x+0.35,c.y+0.6);a.fill();a.fillStyle=k(0,0,0,b);a.beginPath();a.moveTo(c.x-0.1,c.y-0.45);a.lineTo(c.x-0.1,c.y-0.4);a.lineTo(c.x+0.1,c.y-0.4);a.lineTo(c.x+0.1,c.y-0.45);a.arc(c.x,c.y-0.45,0.2,0,Math.PI,i);a.fill()};l.$a=function(a,b,c,d){d=d-Math.floor(d);d=1-d;d=(d-Math.pow(d,6))*1.72;d=1-d;a.fillStyle=k(0,0,0,b);for(b=0;b<4;++b){var f=b*(2*Math.PI/4),e=Math.sin(f);f=Math.cos(f);var g=0.45-d*0.25;a.beginPath();a.moveTo(c.x+f*g-e*0.15,c.y+e*g+f*0.15);a.lineTo(c.x+f*g+e*0.15,c.y+e*g-
f*0.15);a.lineTo(c.x+f*(g-0.15),c.y+e*(g-0.15));a.fill()}};l.sb=function(a,b,c){var d=c*0.8,f=c*0.2,e=c*0.075,g,j,p;a.fillStyle=k(255,255,0,b);a.beginPath();for(b=0;b<=64;b++){g=(b+0.25)/64*Math.PI*2;j=Math.sin(g);p=Math.cos(g);g=c*(1+Math.cos(g*10)*0.1);a.lineTo(p*g,j*g)}a.closePath();a.arc(0,0,c*0.65,0,Math.PI*2,i);a.closePath();for(b=0;b<5;b++){g=b/5*Math.PI*2;j=Math.sin(g);p=Math.cos(g);a.moveTo(j*f,-p*f);a.lineTo(p*d+j*e,j*d-p*e);a.lineTo(p*d-j*e,j*d+p*e);a.lineTo(-j*f,p*f);a.closePath()}a.fill()};
l.pb=function(a,b,c){a.save();a.translate(0,0.05);a.strokeStyle=k(0,0,0,b);a.beginPath();a.moveTo(-0.25,-0.2);a.lineTo(-0.25,-0.1);a.lineTo(-0.1,0.05);a.lineTo(0.1,0.05);a.lineTo(0.25,-0.1);a.lineTo(0.25,-0.2);a.arc(0,-0.2,0.15,0,Math.PI,q);a.lineTo(-0.25,-0.2);a.moveTo(-0.1,0.05);a.lineTo(-0.2,0.15);a.moveTo(0.1,0.05);a.lineTo(0.2,0.15);a.stroke();a.fillStyle=k(0,0,0,b);a.beginPath();a.arc(0,-0.2,0.15*c,0,2*Math.PI,q);a.fill();a.restore()};l.qb=function(a,b,c){var d=Math.sqrt(0.2*0.2-0.1*0.1);a.strokeStyle=
k(0,0,0,b);a.beginPath();a.moveTo(-d,-0.1);a.lineTo(-0.3,-0.1);a.lineTo(-0.3,0.1);a.lineTo(-d,0.1);a.stroke();a.fillStyle=k(255*c,0,255*!c,b);a.beginPath();a.arc(0,0,0.2,1.65*Math.PI,2.35*Math.PI,i);a.fill();a.fillStyle=k(255*!c,0,255*c,b);a.beginPath();a.arc(0,0,0.2,1.65*Math.PI,2.35*Math.PI,q);a.fill();a.beginPath();a.arc(0,0,0.2,0,2*Math.PI,q);a.stroke();a.beginPath();a.moveTo(Math.cos(1.65*Math.PI)*0.2,Math.sin(1.65*Math.PI)*0.2);a.lineTo(Math.cos(2.35*Math.PI)*0.2,Math.sin(2.35*Math.PI)*0.2);
a.stroke()};l.tb=function(a,b){for(var c=-1;c<=1;c+=2){a.fillStyle=k(0,0,255,b);a.beginPath();a.moveTo(-0.3,c*0.05);a.lineTo(-0.3,c*0.15);a.lineTo(-0.3+(0.15-0.05),c*0.15);a.lineTo(-0.3+(0.15-0.05),c*0.05);a.fill();a.fillStyle=k(255,0,0,b);a.beginPath();a.moveTo(0.3,c*0.05);a.lineTo(0.3,c*0.15);a.lineTo(0.3-(0.15-0.05),c*0.15);a.lineTo(0.3-(0.15-0.05),c*0.05);a.fill()}a.strokeStyle=k(0,0,0,b);a.beginPath();a.arc(0.15,0,0.15,1.5*Math.PI,0.5*Math.PI,i);a.lineTo(0.3,0.15);a.lineTo(0.3,0.05);a.arc(0.15,
0,0.05,0.5*Math.PI,1.5*Math.PI,q);a.lineTo(0.3,-0.05);a.lineTo(0.3,-0.15);a.lineTo(0.15,-0.15);a.stroke();a.beginPath();a.arc(-0.15,0,0.15,1.5*Math.PI,2.5*Math.PI,q);a.lineTo(-0.3,0.15);a.lineTo(-0.3,0.05);a.arc(-0.15,0,0.05,2.5*Math.PI,1.5*Math.PI,i);a.lineTo(-0.3,-0.05);a.lineTo(-0.3,-0.15);a.lineTo(-0.15,-0.15);a.stroke()};l.ub=function(a,b,c){a.fillStyle=k(255*c,0,255*!c,b);a.strokeStyle=k(0,0,0,b);a.beginPath();a.moveTo(-0.25,-0.25);a.lineTo(-0.175,-0.25);a.lineTo(-0.175,-0.02);a.lineTo(0,0.175);
a.lineTo(0.175,-0.02);a.lineTo(0.175,-0.25);a.lineTo(0.25,-0.25);a.lineTo(0.25,0);a.lineTo(0,0.27);a.lineTo(-0.25,0);a.closePath();a.fill();a.stroke()};l.xb=function(a,b){function c(d){d.beginPath();d.moveTo(0,0.1);for(var f=0;f<=6;f++)d.lineTo((f&1)/24,0.2+f*0.05);d.arc(0,0.2,0.3,0.5*Math.PI,-0.5*Math.PI,i);d.stroke()}a.strokeStyle=k(0,0,0,b);a.beginPath();a.arc(0,-0.2,0.1,0,2*Math.PI,q);a.stroke();a.save();a.translate(0,-0.2);a.rotate(-0.1);c(a);a.rotate(0.2);a.scale(-1,1);c(a);a.restore()};l.zb=
function(a,b){a.fillStyle=a.strokeStyle=k(0,0,0,b);(function(c,d,f){c.save();c.translate(d,f);c.beginPath();c.moveTo(0.2,-0.2);c.lineTo(-0.2,-0.2);c.lineTo(-0.3,0);c.lineTo(-0.2,0.2);c.lineTo(0.2,0.2);c.lineTo(0.3,0);c.lineTo(0.2,-0.2);c.moveTo(0.15,-0.15);c.lineTo(-0.15,-0.15);c.lineTo(-0.23,0);c.lineTo(-0.15,0.15);c.lineTo(0.15,0.15);c.lineTo(0.23,0);c.lineTo(0.15,-0.15);c.stroke();c.beginPath();c.arc(-0.075,0,0.04,0,2*Math.PI,q);c.arc(0.075,0,0.04,0,2*Math.PI,q);c.fill();c.restore()})(a,0,0.1);
A(a,-0.2,-0.1,-80,100,0.3);A(a,-0.1,-0.1,-80,100,0.3);A(a,0.1,-0.1,80,-100,0.3);A(a,0.2,-0.1,80,-100,0.3)};for(var ka=[],la=0;la<50;la++){var ma=0+(Math.PI*2-0)*Math.random(),na=Math.sqrt(Math.random())*0.4;ka.push({lb:Math.cos(ma)*na,mb:Math.sin(ma)*na,r:0.05+(0.15-0.05)*Math.random(),ib:0.1+0.4*Math.random()})}l.rb=function(a,b,c){for(var d=0;d<50;d++){a.fillStyle=k(127*c,0,127*!c,b*ka[d].ib);a.beginPath();a.arc(ka[d].lb,ka[d].mb,ka[d].r,0,Math.PI*2,q);a.fill()}};l.Bb=function(a,b,c){a.fillStyle=
k(255*c,0,255*!c,b);a.beginPath();a.moveTo(0,-0.15);a.lineTo(0.05,-0.1);a.lineTo(0,0.1);a.lineTo(-0.05,-0.1);a.fill();a.strokeStyle=k(0,0,0,b);a.beginPath();for(b=-1;b<=1;b+=2){a.moveTo(0,-0.3);a.lineTo(b*0.05,-0.2);a.lineTo(b*0.1,-0.225);a.lineTo(b*0.1,-0.275);a.lineTo(b*0.15,-0.175);a.lineTo(0,0.3);a.moveTo(0,-0.15);a.lineTo(b*0.05,-0.1);a.lineTo(0,0.1)}a.stroke()};l.Fb=function(a,b,c){function d(f){var e=Math.sin(Math.PI/4);f.beginPath();f.arc(0,0,0.2,0,Math.PI/2,q);f.arc(0,0,0.15,Math.PI/2,0,
i);f.closePath();f.moveTo(e*0.15,e*0.15);f.lineTo(e*0.1,e*0.1);f.stroke()}a.fillStyle=k(255*c,0,255*!c,b);a.strokeStyle=k(0,0,0,b);a.beginPath();a.arc(0,0,0.1,0,Math.PI*2,q);a.fill();a.stroke();b=Math.PI/2;a.save();a.rotate(-b);d(a);a.rotate(2*b);a.scale(-1,1);d(a);a.restore()};l.Gb=function(a,b,c){a.fillStyle=k(255*c,0,255*!c,b);a.strokeStyle=k(0,0,0,b);a.beginPath();a.arc(0,0,0.1,0,2*Math.PI,q);a.fill();a.stroke();a.beginPath();for(b=0;b<4;b++){var d=b*(2*Math.PI/4);c=Math.cos(d);d=Math.sin(d);
a.moveTo(c*0.1,d*0.1);a.lineTo(c*0.3,d*0.3);a.moveTo(c*0.16-d*0.1,d*0.16+c*0.1);a.lineTo(c*0.16+d*0.1,d*0.16-c*0.1);a.moveTo(c*0.23-d*0.05,d*0.23+c*0.05);a.lineTo(c*0.23+d*0.05,d*0.23-c*0.05)}a.stroke()};l.Hb=function(a,b){a.fillStyle=a.strokeStyle=k(0,0,0,b);a.beginPath();a.arc(0,0,0.25,Math.PI*0.25+0.15,Math.PI*0.75-0.15,q);a.stroke();a.beginPath();a.arc(0,0,0.25,Math.PI*0.75+0.15,Math.PI*1.25-0.15,q);a.stroke();a.beginPath();a.arc(0,0,0.25,Math.PI*1.25+0.15,Math.PI*1.75-0.15,q);a.stroke();a.beginPath();
a.arc(0,0,0.25,Math.PI*1.75+0.15,Math.PI*2.25-0.15,q);a.stroke();a.beginPath();a.arc(0,0,0.15,0,2*Math.PI,q);a.stroke();a.beginPath();a.moveTo(0.15,0);a.lineTo(0.25,0);a.moveTo(0,0.15);a.lineTo(0,0.25);a.moveTo(-0.15,0);a.lineTo(-0.25,0);a.moveTo(0,-0.15);a.lineTo(0,-0.25);a.stroke();a.beginPath();a.arc(0,0,0.05,0,2*Math.PI,q);a.fill()};l.Ib=function(a,b){a.fillStyle=a.strokeStyle=k(0,0,0,b);a.beginPath();a.arc(0,0,0.3,0,2*Math.PI,q);a.arc(0,0,0.3-0.1,Math.PI,3*Math.PI,q);a.stroke();for(var c=0;c<
4;c++){var d=c*(2*Math.PI/4),f=d+Math.PI/4;a.beginPath();a.arc(0,0,0.3,d,f,q);a.arc(0,0,0.3-0.1,f,d,i);a.fill()}};var Ra=[Oa(11),Oa(13),Oa(7)];l.Eb=function(a,b){a.strokeStyle=k(0,0,0,b);Ra[0](a);Ra[1](a);Ra[2](a)};l.Ab=function(a,b,c,d){function f(){a.beginPath();for(var H=0;H<3;H++){var I=H*(2*Math.PI/3);a.moveTo(0,0);a.lineTo(0.2*Math.cos(I),0.2*Math.sin(I))}a.stroke()}var e=c*(2*Math.PI/3),g=d-Math.PI/2;d=h.Ga(g).q(0.2);a.fillStyle=k(255,255,0,b);a.strokeStyle=k(0,0,0,b);a.save();a.translate(-0.2,
0);a.rotate(g+e);f();a.restore();a.save();a.translate(0.2,0);a.rotate(g-e);f();a.restore();for(b=-1;b<=1;b+=2)for(g=0;g<3;g++){var j=(c-g*b)/3+(b==1)*0.5,p=d.q(b).add(d.rotate(g*(2*Math.PI/3)-b*e));j-=Math.floor(j);a.beginPath();a.arc(p.x,p.y,0.1*j,0,2*Math.PI,q);a.fill();a.stroke()}};l.yb=function(a,b){a.strokeStyle=k(0,0,0,b);for(var c=-1;c<=1;c+=2)for(var d=-1;d<=1;d+=2){a.beginPath();a.moveTo(-0.25,0.25*c+0.1*d);a.lineTo(0.25,0.25*c+0.1*d);a.moveTo(0.25*c+0.1*d,-0.25);a.lineTo(0.25*c+0.1*d,0.25);
a.stroke();a.beginPath();a.arc(0.25*c,0.25*d,0.1,0,Math.PI*2,q);a.stroke()}};l.Db=function(a,b){a.save();a.translate(0,0.51);var c,d,f;a.fillStyle=a.strokeStyle=k(0,0,0,b);a.beginPath();for(c=0;c<=21;c++){f=(0.25+0.5*c/21)*Math.PI;d=0.6+0.05*(c&2);a.lineTo(Math.cos(f)*d,Math.sin(f)*d-0.5)}a.arc(0,-0.5,0.5,Math.PI*0.75,Math.PI*0.25,i);a.fill();A(a,0.315,0,-10,70,0.5);A(a,0.135,0,10,20,0.5);A(a,0.9*-0.05,0,-10,20,0.5);A(a,-0.225,0,-20,10,0.5);A(a,0.225,0,-10,20,0.5);A(a,0.9*0.05,0,-20,10,0.5);A(a,-0.135,
0,-10,70,0.5);A(a,-0.315,0,10,20,0.5);a.restore()};l.Fa=function(a,b){a.fillStyle=k(255,255,255,b);a.strokeStyle=k(0,0,0,b);a.beginPath();a.arc(0,0,0.11,0,2*Math.PI,q);a.fill();a.stroke();a.beginPath();for(var c=0;c<3;c++){a.moveTo(0,0);var d=h.Ga(c*(2*Math.PI/3)).q(0.11);a.lineTo(d.x,d.y)}a.stroke()};var Sa=[];for(la=0;la<50;la++){ma=0+(Math.PI*2-0)*Math.random();na=Math.sqrt(Math.random())*0.3;Sa.push({x:Math.cos(ma)*na,y:Math.sin(ma)*na})}l.wb=function(a,b,c){var d=0.15*0.75;a.strokeStyle=k(0,
0,0,b);a.beginPath();for(var f=0;f<Sa.length;f++){var e=Sa[f];a.lineTo(e.x,e.y)}a.stroke();a.fillStyle=k(255*c,0,255*!c,b);a.beginPath();a.arc(0,0,d,0,2*Math.PI,q);a.fill();a.stroke()};l.Cb=function(a,b,c){a.save();a.textAlign="center";a.scale(0.02,-0.02);a.lineWidth*=50;a.save();a.font="bold 34px sans-serif";a.fillStyle="yellow";a.strokeStyle="black";a.translate(0,12);a.fillText("?",0,0);a.strokeText("?",0,0);a.restore();b=jb(a,c);var d=-25-15*b.length/2;c=b.length;if(!(c<1)){a.font="13px Arial, sans-serif";
for(var f=15*c,e=-1,g=0;g<c;++g){var j=a.measureText(b[g]).width;if(e<j)e=j}a.fillStyle="#BFBFBF";a.strokeStyle="#7F7F7F";g=0-e/2-ta;j=d-f/2-ua;a.fillRect(g,j,e+ta*2,f+ua*2);a.strokeRect(g,j,e+ta*2,f+ua*2);a.fillStyle="black";a.textAlign="center";d=d+4-(c-1)*15/2;for(g=0;g<c;++g){a.fillText(b[g],0,d);d+=15}}a.restore()};aa.prototype.t=P("Oa");aa.prototype.h=function(a){this.J.x-=a.x-this.Oa.x;this.J.y-=a.y-this.Oa.y};aa.prototype.A=x();aa.prototype.c=x();var kb=0,wb=1,lb=2;N.prototype.t=function(a){this.a.g.ea();
this.z=i;this.h(a)};N.prototype.h=function(a){this.X=Math.floor(a.x);this.R=Math.floor(a.y);this.fa=this.i==lb?a.x-this.X<0.5?a.y-this.R<0.5?va:wa:a.y-this.R<0.5?xa:ya:this.i==kb?E:S;this.z&&this.a.b.ja(this.X,this.R)!=this.fa&&this.a.s(this.X,this.R,this.fa)};N.prototype.A=function(){this.a.g.Y();this.z=q};N.prototype.c=function(a){if(this.fa!=m){var b=new ra;b.type=this.fa;a.fillStyle=k(191,191,191,0.5);b.c(a,this.X,this.R);b.Kb();a.fillStyle=k(127,127,127,0.5);b.c(a,this.X,this.R)}};ba.prototype.t=
function(a){this.h(a);this.a.V(new s(this.$,this.F,this.color,this.e))};ba.prototype.h=function(a){var b=Math.floor(a.x),c=Math.floor(a.y),d=new h(b,c),f=new h(b+1,c),e=new h(b,c+1);b=new h(b+1,c+1);this.e=Ua.Lb(a,[new t(d,f),new t(e,d),new t(d,b),new t(f,e),new t(f,b),new t(b,e)]);this.e.ma(a)&&this.e.D()};ba.prototype.A=x();ba.prototype.c=function(a){this.e!=m&&(new s(this.$,q,this.color,this.e)).c(a,0.5)};var ib=0;ca.prototype.t=function(a){var b,c;this.U=this.a.b.getSelection();this.a.g.ea();
var d=q;b=new h(0.1,0.1);var f=this.a.b.Ra(new D(a.sub(b),a.add(b)));for(b=0;b<f.length;b++)for(c=0;c<this.U.length;c++)if(f[b]==this.U[c]){d=i;break}if(d){this.i=2;this.start=a}else{d=q;for(b=0;b<this.U.length;b++){c=this.U[b];if(c instanceof o&&c.db())if(c.cb().ga(a)){d=i;this.Qa=c.anchor;break}}if(d){this.i=3;this.start=a}else if(!this.La&&f.length>0){this.i=2;this.start=a;this.a.N(f)}else{this.i=1;this.start=this.end=a;this.h(a)}}};ca.prototype.h=function(a){this.end=a;if(this.i==1){a=this.a.b.Ra(new D(this.start,
this.end));if(this.La)for(var b=0;b<this.U.length;b++){for(var c=this.U[b],d=0;d<a.length;d++)if(c==a[d])break;d==a.length?a.push(c):a.splice(d--,1)}this.a.N(a)}else if(this.i==2){this.a.Tb(a.sub(this.start));this.start=a}else if(this.i==3){this.a.ac(a.sub(this.Qa).atan2()-this.start.sub(this.Qa).atan2());this.start=a}};ca.prototype.A=function(){if(this.i==2)for(var a=this.a.b.getSelection(),b=0;b<a.length;b++)a[b].na();this.i=ib;this.a.g.Y()};ca.prototype.c=function(a){if(this.i==1){a.fillStyle=
k(0,0,0,0.1);a.strokeStyle=k(0,0,0,0.5);a.fillRect(this.start.x,this.start.y,this.end.x-this.start.x,this.end.y-this.start.y);a.strokeRect(this.start.x,this.start.y,this.end.x-this.start.x,this.end.y-this.start.y)}};da.prototype.t=function(a){this.z=i;this.a.g.ea();this.h(a)};da.prototype.h=function(a){this.z&&this.a.dc(new h(Math.floor(a.x),Math.floor(a.y)));this.v=a};da.prototype.A=function(){this.z=q;this.a.g.Y()};da.prototype.c=function(a){this.v!=m&&l.bb(a,0.5,this.v.floor().add(new h(0.5,0.5)))};
ea.prototype.t=function(a){this.z=i;this.a.g.ea();this.h(a)};ea.prototype.h=function(a){this.z&&this.a.cc(new h(Math.floor(a.x),Math.floor(a.y)));this.v=a};ea.prototype.A=function(){this.z=q;this.a.g.Y()};ea.prototype.c=function(a){this.v!=m&&l.$a(a,0.5,this.v.floor().add(new h(0.5,0.5)),0.6)};K.prototype.t=function(a){this.h(a);var b=this.la.clone(this.v,this.la.color);this.a.V(b);if(this.la.id==O){this.a.N([b]);Za(b.text,function(c){n.a.gb(b,c);n.c()})}};K.prototype.h=P("v");K.prototype.A=x();K.prototype.c=
function(a){this.v!=m&&this.la.clone(this.v,this.la.color).c(a,0.5)};fa.prototype.t=function(a){this.h(a);this.Ja=this.n!==m;this.h(a)};fa.prototype.h=function(a){var b=this.a.b.Da(a,v),c=this.a.b.Da(a,s);if(this.Ja){this.I=this.n instanceof v?c:this.n instanceof s?b:m;this.ua=this.n!==m&&this.I!==m}else{var d=b!==m?b.p().sub(a).L():Number.POSITIVE_INFINITY;a=c!==m?c.p().sub(a).L():Number.POSITIVE_INFINITY;this.n=d<a?b:c;this.I=m;this.ua=q}};fa.prototype.A=function(a){this.h(a);if(this.ua){for(var b=
this.n instanceof v?this.n:this.I,c=this.n instanceof s?this.n:this.I,d=q,f=this.a.b.d,e=0;e<f.length;e++)if(f[e]instanceof w&&f[e].button==b&&f[e].m==c){d=i;break}d||this.a.V(new w(b,c))}this.Ja=q;this.h(a)};fa.prototype.c=function(a){a.fillStyle=k(0,0,0,0);a.strokeStyle=k(0,0,0,0.5);this.n!==m&&this.n.S(a);this.I!==m&&this.I.S(a);if(this.ua){var b=this.n instanceof s?this.n:this.I;Ka(a,(this.n instanceof v?this.n:this.I).p(),b.p())}};ga.prototype.t=function(a){this.h(a);this.m!=m&&this.a.hc(this.m)};
ga.prototype.h=function(a){this.m=this.a.b.Da(a,s)};ga.prototype.A=x();ga.prototype.c=function(a){if(this.m!=m){a.fillStyle=k(0,0,0,0);a.strokeStyle=k(0,0,0,0.5);this.m.S(a)}};var E=0,S=1,va=2,xa=3,wa=4,ya=5,r=8;ra.prototype.c=function(a,b,c){switch(this.type){case E:a.strokeRect(b,c,1,1);a.fillRect(b,c,1,1);break;case wa:a.beginPath();a.moveTo(b,c);a.lineTo(b+1,c);a.lineTo(b+1,c+1);a.stroke();a.fill();break;case ya:a.beginPath();a.moveTo(b,c);a.lineTo(b+1,c);a.lineTo(b,c+1);a.stroke();a.fill();break;
case va:a.beginPath();a.moveTo(b+1,c);a.lineTo(b+1,c+1);a.lineTo(b,c+1);a.stroke();a.fill();break;case xa:a.beginPath();a.moveTo(b,c);a.lineTo(b+1,c+1);a.lineTo(b,c+1);a.stroke();a.fill()}};ra.prototype.Kb=function(){switch(this.type){case E:this.type=S;break;case S:this.type=E;break;case wa:this.type=xa;break;case ya:this.type=va;break;case va:this.type=ya;break;case xa:this.type=wa}};ha.prototype.c=function(a){for(var b=this.offset.x*r,c=this.offset.y*r,d=0,f=0;d<r;d++)for(var e=0;e<r;e++,f++)this.cells[f].c(a,
b+e,c+d)};ha.prototype.ja=function(a,b){a-=this.offset.x*r;b-=this.offset.y*r;return this.cells[a+b*r].type};ha.prototype.s=function(a,b,c){a-=this.offset.x*r;b-=this.offset.y*r;this.cells[a+b*r].type=c};z.prototype.c=function(a){var b,c,d;a.strokeStyle="#BFBFBF";a.fillStyle="#BFBFBF";for(d=c=0;c<this.size.y;c++)for(b=0;b<this.size.x;b++,d++)this.G[d].c(a);l.$a(a,1,this.B.add(new h(0.5,0.5)),0.6);l.bb(a,1,this.u.add(new h(0.5,0.5)));for(d=0;d<this.d.length;d++)this.d[d].c(a);a.fillStyle=k(0,0,0,0.1);
a.strokeStyle=k(0,0,0,0.5);for(d=0;d<this.d.length;d++)this.d[d].selected&&this.d[d].S(a)};z.prototype.Xa=function(a,b){return a>=this.offset.x&&a<this.offset.x+this.size.x&&b>=this.offset.y&&b<this.offset.y+this.size.y};z.prototype.ja=function(a,b){var c=Math.floor(a/r),d=Math.floor(b/r);return this.Xa(c,d)?this.G[c-this.offset.x+(d-this.offset.y)*this.size.x].ja(a,b):S};z.prototype.s=function(a,b,c){var d=Math.floor(a/r),f=Math.floor(b/r);if(this.G.length==0){this.G.push(new ha(d,f));this.offset=
new h(d,f);this.size=new h(1,1)}else if(!this.Xa(d,f)){var e=this.offset,g=this.size,j=this.G;this.offset=new h(Math.min(d,e.x),Math.min(f,e.y));this.size=new h(Math.max(d-e.x+1,g.x+(e.x-this.offset.x)),Math.max(f-e.y+1,g.y+(e.y-this.offset.y)));this.G=Array(this.size.x*this.size.y);for(var p=0,H=0;p<this.size.y;p++)for(var I=this.offset.y+p-e.y,za=0;za<this.size.x;za++,H++){var Ta=this.offset.x+za-e.x;this.G[H]=Ta>=0&&I>=0&&Ta<g.x&&I<g.y?j[Ta+I*g.x]:new ha(this.offset.x+za,this.offset.y+p)}}this.G[d-
this.offset.x+(f-this.offset.y)*this.size.x].s(a,b,c)};z.prototype.V=function(a){this.d.push(a)};z.prototype.wa=function(a){for(var b=0;b<this.d.length;b++)this.d[b]==a&&this.d.splice(b--,1)};z.prototype.Da=function(a,b){for(var c=Number.MAX_VALUE,d=m,f=0;f<this.d.length;f++){var e=this.d[f];if(e instanceof b){var g=e.p().sub(a).length();if(g<c){d=e;c=g}}}return d};z.prototype.getSelection=function(){for(var a=[],b=0;b<this.d.length;b++)this.d[b].selected&&a.push(this.d[b]);return a};z.prototype.Ra=
function(a){for(var b=[],c=0;c<this.d.length;c++)this.d[c].za(a)&&b.push(this.d[c]);return b};z.prototype.N=function(a){for(var b=0;b<this.d.length;b++){var c=this.d[b];c.selected=q;for(var d=0;d<a.length;d++)if(a[d]==c){c.selected=i;break}}};v.prototype.c=function(a,b){var c=["Open","Close","Toggle"][this.type];a.save();a.translate(this.anchor.x,this.anchor.y);l.Fa(a,b||1);a.fillStyle=k(0,0,0,b||1);a.scale(1/150,-1/150);a.font='15px "Lucida Grande", Helvetica, Arial, sans-serif';a.fillText(c,-a.measureText(c).width/
2,35);a.restore()};v.prototype.S=function(a){a.beginPath();a.arc(this.anchor.x,this.anchor.y,0.3,0,Math.PI*2,q);a.closePath();a.fill();a.stroke()};v.prototype.za=function(a){return(new ia(this.anchor,0.11)).Z(a)};v.prototype.sa=Q("anchor");v.prototype.oa=P("anchor");v.prototype.na=x();v.prototype.clone=function(a){return new v(a,this.type)};v.prototype.p=Q("anchor");v.prototype.ta=function(){return 0};v.prototype.pa=x();s.prototype.c=function(a,b){a.strokeStyle=k(255*(this.color==Va),0,255*(this.color==
Wa),b||1);if(this.F){this.e.ab(a);if(!this.$){this.e.D();this.e.ab(a);this.e.D()}}else{this.e.c(a);if(!this.$){this.e.D();this.e.c(a);this.e.D()}}};s.prototype.S=function(a){var b=this.e.end.sub(this.e.start).atan2()+Math.PI/2;a.beginPath();a.arc(this.e.start.x,this.e.start.y,0.2,b,b+Math.PI,q);a.arc(this.e.end.x,this.e.end.y,0.2,b+Math.PI,b,q);a.closePath();a.fill();a.stroke()};s.prototype.za=function(a){return a.Z(new D(this.e.start,this.e.end))&&a.T(this.e)};s.prototype.sa=Q("anchor");s.prototype.oa=
function(a){var b=new h(Math.floor(a.x+0.5),Math.floor(a.y+0.5));this.anchor=a;this.e.start=b.add(this.Vb);this.e.end=b.add(this.Ub)};s.prototype.na=function(){this.anchor=new h(Math.min(this.e.start.x,this.e.end.x),Math.min(this.e.start.y,this.e.end.y))};s.prototype.p=function(){return this.e.start.add(this.e.end).ha(2)};s.prototype.ta=function(){return 0};s.prototype.pa=x();w.prototype.c=function(a){a.strokeStyle=k(0,0,0,0.5);Ka(a,this.button.p(),this.m.p())};w.prototype.S=function(a){var b=this.button.p(),
c=this.m.p(),d=c.sub(b).atan2()+Math.PI/2;a.beginPath();a.arc(b.x,b.y,0.2,d,d+Math.PI,q);a.arc(c.x,c.y,0.2,d+Math.PI,d,q);a.closePath();a.fill();a.stroke()};w.prototype.za=function(a){var b=this.button.p(),c=this.m.p();return a.Z(new D(b,c))&&a.T(new t(b,c))};w.prototype.sa=function(){return new h(0,0)};w.prototype.oa=x();w.prototype.na=x();w.prototype.ta=function(){return 0};w.prototype.pa=x();var pa=0,Ja=6,qa=9,Ea=10,Fa=16,sa=17,O=18;o.prototype.cb=function(){var a=h.Ga(this.W);return new Pa(this.anchor.add(a.q(this.r+
0.4)),this.anchor.add(a.q(this.r+0.2).add(a.D().q(0.2))),this.anchor.add(a.q(this.r+0.2).sub(a.D().q(0.2))))};o.prototype.db=function(){return this.id==5||this.id==8||this.id==qa||this.id==pa};o.prototype.c=function(a,b){a.save();this.Wa(a);a.translate(this.anchor.x,this.anchor.y);this.Za(a,b||1,this.color,this.W);a.restore()};o.prototype.Wa=function(a){var b=jb(a,this.text),c=new h(0,25+15*b.length/2),d=b.length;a.font="13px Arial, sans-serif";for(var f=15*d,e=-1,g=0;g<d;++g){var j=a.measureText(b[g]).width;
if(e<j)e=j}this.O=(new D(c,c)).expand(e/2+ta,f/2+ua);this.O.min=this.O.min.ha(50).add(this.anchor);this.O.max=this.O.max.ha(50).add(this.anchor)};o.prototype.S=function(a){a.beginPath();a.arc(this.anchor.x,this.anchor.y,this.r+0.1,0,Math.PI*2,q);a.fill();a.stroke();this.db()&&this.cb().c(a);if(this.id==O){this.Wa(a);var b=this.O.expand(0.1,0.1),c=b.min.x,d=b.min.y,f=b.max.x-b.min.x;b=b.max.y-b.min.y;a.fillRect(c,d,f,b);a.strokeRect(c,d,f,b)}};o.prototype.za=function(a){return(new ia(this.anchor,this.r)).Z(a)||
this.O!==m&&this.O.Z(a)};o.prototype.sa=Q("anchor");o.prototype.oa=P("anchor");o.prototype.na=x();o.prototype.clone=function(a,b,c){return new o(this.id,this.r,this.Za,a,b,c)};o.prototype.p=Q("anchor");o.prototype.ta=Q("W");o.prototype.pa=P("W");var C=[{name:"Bomber",f:new o(pa,0.3,function(a,b){l.pb(a,b,0.7)})},{name:"Doom Magnet",f:new o(1,0.35,function(a,b){l.tb(a,b)})},{name:"Hunter",f:new o(2,0.3,function(a,b){l.xb(a,b)})},{name:"Multi-Gun",f:new o(3,0.45,function(a,b){l.yb(a,b)})},{name:"Popper",
f:new o(4,0.5,function(a,b){l.zb(a,b)})},{name:"Jet Stream",f:new o(5,0.45,function(a,b,c,d){a.rotate(d-Math.PI/2);l.Ab(a,b,0.75,Math.PI/2)})},{name:"Rocket Spider",f:new o(Ja,0.5,function(a,b){l.Db(a,b)})},{name:"Spike Ball",f:new o(7,0.3,function(a,b){l.Eb(a,b)})},{name:"Wall Crawler",f:new o(8,0.25,function(a,b){l.Hb(a,b)})},{name:"Wheeligator",f:new o(qa,0.3,function(a,b){l.Ib(a,b)})},{name:"Bouncy Rockets",f:new o(Ea,0.3,function(a,b,c){l.qb(a,b,c==1)})},{name:"Corrosion Cloud",f:new o(11,0.5,
function(a,b,c){l.rb(a,b,c==1)})},{name:"Grenadier",f:new o(12,0.35,function(a,b,c){l.ub(a,b,c==1)})},{name:"Headache",f:new o(13,0.5,function(a,b,c){l.wb(a,b,c==1)})},{name:"Shock Hawk",f:new o(14,0.3,function(a,b,c){l.Bb(a,b,c==1)})},{name:"Stalacbat",f:new o(15,0.2,function(a,b,c){l.Fb(a,b,c==1)})},{name:"Wall Avoider",f:new o(Fa,0.3,function(a,b,c){l.Gb(a,b,c==1)})},{name:"Cog",f:new o(sa,0.25,function(a,b){l.sb(a,b,0.25)})},{name:"Sign",f:new o(O,0.25,function(a,b){l.Cb(a,b,this.text)})}],Qa=
{bomber:pa,"doom magnet":1,grenadier:12,headache:13,popper:4,"jet stream":5,"shock hawk":14,stalacbat:15,"wall crawler":8,wheeligator:qa,"rocket spider":Ja,hunter:2,"wall avoider":Fa,"spike ball":7,"corrosion cloud":11,"bouncy rocket launcher":Ea,"multi gun":3},La=0,Va=1,Wa=2,ta=6,ua=6,vb=1.5;D.prototype.Z=function(a){return this.min.x<a.max.x&&a.min.x<this.max.x&&this.min.y<a.max.y&&a.min.y<this.max.y};D.prototype.T=function(a){var b=0;b+=a.ma(this.min);b+=a.ma(new h(this.min.x,this.max.y));b+=a.ma(new h(this.max.x,
this.min.y));b+=a.ma(this.max);return b!=0&&b!=4};D.prototype.ga=function(a){return a.x>=this.min.x&&a.x<this.max.x&&a.y>=this.min.y&&a.y<this.max.y};D.prototype.expand=function(a,b){var c=new h(a,b);return new D(this.min.sub(c),this.max.add(c))};ia.prototype.Z=function(a){var b=new h(a.min.x,a.max.y),c=a.max,d=a.min,f=new h(a.max.x,a.min.y);return a.ga(this.Ca)||this.T(new t(b,c))||this.T(new t(c,f))||this.T(new t(f,d))||this.T(new t(d,b))||this.ga(a.min)};ia.prototype.T=function(a){var b=a.end.sub(a.start),
c=a.start.sub(this.Ca);a=b.L();b=2*b.ia(c);c=b*b-4*a*(c.L()-this.r*this.r);if(c>=0){b=-b/(2*a);c=Math.sqrt(c)/(2*a);a=b+c;b=b-c;return a>=0&&a<=1||b>=0&&b<=1}return q};ia.prototype.ga=function(a){return this.Ca.sub(a).L()<this.r*this.r};Pa.prototype.c=function(a){a.beginPath();for(var b=0;b<this.ba.length;b++){var c=this.ba[b];a.lineTo(c.x,c.y)}a.closePath();a.fill();a.stroke()};Pa.prototype.ga=function(a){for(var b=0,c=0;c<this.ba.length;c++){var d=(c+1)%this.ba.length,f=this.ba[c].sub(a).Ta();d=
this.ba[d].sub(a).Ta();b+=Math.acos(f.ia(d))}return Math.abs(Math.abs(b)-2*Math.PI)<0.001};ja.prototype.l=function(){for(var a=this.k.length-1;a>=0;a--)this.k[a].l()};ja.prototype.j=function(){for(var a=0;a<this.k.length;a++)this.k[a].j()};B.prototype.Va=function(a){if(!(a instanceof ja&&a.k.length==0))if(this.H.length==0){this.k=this.k.slice(0,this.C);if(this.qa>this.C)this.qa=-1;this.k.push(a);this.C++}else{var b=this.H[this.H.length-1].k;if(b.length>0){var c=b[b.length-1];if("mergeWith"in c&&c.aa(a))return}b.push(a)}};
B.prototype.push=function(a){this.Va(a);a.j()};B.prototype.kb=function(){return this.H.length==0&&this.C>0};B.prototype.jb=function(){return this.H.length==0&&this.C<this.k.length};B.prototype.ea=function(){this.H.push(new ja)};B.prototype.Y=function(){this.H.length>0&&this.Va(this.H.pop())};B.prototype.Jb=function(){for(;this.H.length>0;)this.Y()};B.prototype.l=function(){this.kb()&&this.k[--this.C].l()};B.prototype.j=function(){this.jb()&&this.k[this.C++].j()};B.prototype.eb=P("qa");h.prototype.add=
function(a){return new h(this.x+a.x,this.y+a.y)};h.prototype.sub=function(a){return new h(this.x-a.x,this.y-a.y)};h.prototype.q=function(a){return new h(this.x*a,this.y*a)};h.prototype.ha=function(a){return new h(this.x/a,this.y/a)};h.prototype.ia=function(a){return this.x*a.x+this.y*a.y};h.prototype.L=function(){return this.ia(this)};h.prototype.length=function(){return Math.sqrt(this.L())};h.prototype.Ta=function(){return this.ha(this.length())};h.prototype.D=function(){return new h(this.y,-this.x)};
h.prototype.atan2=function(){return Math.atan2(this.y,this.x)};h.prototype.rotate=function(a){var b=Math.sin(a);a=Math.cos(a);return new h(this.x*a-this.y*b,this.x*b+this.y*a)};h.prototype.Pb=function(a){return new h(Math.min(this.x,a.x),Math.min(this.y,a.y))};h.prototype.Ob=function(a){return new h(Math.max(this.x,a.x),Math.max(this.y,a.y))};h.prototype.toString=function(){return"("+this.x.toFixed(3)+", "+this.y.toFixed(3)+")"};h.prototype.floor=function(){return new h(Math.floor(this.x),Math.floor(this.y))};
h.Ga=function(a){return new h(Math.cos(a),Math.sin(a))};h.jc=function(a,b,c){return a.add(b.sub(a).q(c))}})();
